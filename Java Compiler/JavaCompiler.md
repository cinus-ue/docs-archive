# JAVA 编译器

## 编译状态
```
INIT(0),
PARSE(1),
ENTER(2),
PROCESS(3),
ATTR(4),
FLOW(5),
TRANSTYPES(6),
TRANSPATTERNS(7),
UNLAMBDA(8),
LOWER(9),
GENERATE(10);
```

## 编译过程
parseFiles(词法和语法分析)->enterTrees(符号表)->processAnnotations(注解处理器)
->flow-(数据及控制流分析)>desugar(解语法糖)->generate(生成字节码)

Package com.sun.source.tree
Provides interfaces to represent source code as abstract syntax trees (AST).

Package javax.annotation.processing
Facilities for declaring annotation processors and for allowing annotation processors to 
communicate with an annotation processing tool environment.


### Syntax Tree
package	                      classes
com.sun.source.tree	          Tree and subtypes
com.sun.tools.javac.tree	  JCTree and subtypes, TreeInfo
com.sun.tools.javac.parser	  Scanner, JavacParser, etc
The Scanner class maps source text into a stream of tokens. The JavacParser class converts 
the stream of tokens into one or more syntax trees.

The classes in the com.sun.source.tree package provide public read access to the syntax trees.

The trees have a “minimalist” API design. Expressions and declarations point to semantic 
information derived from the tree. Use utility classes and visitors to process trees.

1.lexer 
```java
Lexer lexer = scannerFactory.newScanner(input, keepDocComments);
```
Scanner实现Lexer 接口
Scanner调用JavaTokenizer的readToken
2.JavacParser
```java
Parser parser = parserFactory.newParser(content, keepComments(), genEndPos,
                                lineDebugInfo, filename.isNameCompatible("module-info", Kind.SOURCE));
tree = parser.parseCompilationUnit();
```
 
### Semantics – The data model
package	                     classes
javax.lang.model.element	 Element and subtypes
javax.lang.model.type	     TypeMirror and subtypes
javax.lang.model.util	     Elements, Types, etc.
com.sun.tools.javac.code	 Symbol, Type, Annotations, Attribute, TypeAttribute, Types

A Symbol provides semantic information about a declaration. Each subtype of Symbol implements a 
corresponding subtype of Element.

A Type provides semantic information about an expression. Each subtype of Type implements a 
corresponding subtype of TypeMirror.

An Attribute provides semantic information about an annotation. Note: They should not be confused 
with class file attributes, which are completely different.

The Types class provides utility methods for types and symbols.

### Semantics – Creating symbol tables
package	                      classes
com.sun.tools.javac.comp	  Enter, MemberEnter, Annotate

Enter and MemberEnter scan trees for class and member declarations, and initialize symbols.

Annotate scans trees for annotations on class and member declarations, to add information to 
the symbols prior to annotation processing.

### Semantics – Code analysis
package	                      classes
com.sun.tools.javac.comp	  Attr, Check, Infer, Resolve, Flow

Attr, Check, Infer and Resolve analyze all names and expressions within the program.

Flow performs static program flow analysis. It checks the following:

Reachability: can a statement be executed?
Definite Assignment: has a variable been initialized?
Definite Unassignment: has a variable not been initialized?

### Annotation Processing
package	                        classes
javax.annotation.processing	    AbstractProcessor, ProcessingEnvironment, RoundEnvironment
com.sun.tools.javac.model	    JavacElements, JavacTypes, etc
com.sun.tools.javac.processing	JavacProcessingEnvironment

Annotation processing occurs after symbols have been entered (Enter, MemberEnter) but before method analysis (Attr, Flow).

Annotation processing gives users the opportunity to execute code that can analyze method signatures and generate additional 
types to be used in the compilation.

If new files are generated by the user code, the compilation is conceptually restarted.
### Code Simplification
package	                      classes
com.sun.tools.javac.comp	  Lower, TransTypes
com.sun.tools.javac.tree	  TreeTranslator

Lower converts “syntactic sugar” constructions into simpler code. This includes inner classes, class literals, assertions, 
foreach loops, strings in switch, etc., which can all be represented by code not using those constructs.

TransTypes eliminates (erases) generics from the program.

Lower and TransTypes use TreeTranslator to rewrite trees.

### Code Generation
package	                   classes
com.sun.tools.javac.jvm	   all

The Gen and Code classes generate bytecodes for the class file Code attribute.

The Pool class is used to model the class file constant pool.

The CRTable and CRTable classes are used for mapping source positions to bytecodes.

Class files are written out, via the file manager, using ClassWriter.
(ClassWriter->writeClassFile)
